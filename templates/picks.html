{% extends "base.html" %}{% block content %}
<h2>Pick Team</h2>
<div class="grid">
{% for pos in ["GK","DEF","MID","FWD"] %}{% set p = selected[pos] %}
<div class="card player-card">
  <div class="player-pos">{{ pos }}</div>
  {% if p %}
    {% if p.kit_url %}<img class="kit-img" src="{{ p.kit_url }}" alt="{{ p.team_name }} badge">{% endif %}
    <div style="font-weight:700">{{ p.first_name }} {{ p.second_name }}</div>
    <div class="meta">{{ p.team_name }}</div>
    <button class="btn btn-danger" style="margin-top:8px" onclick="removePlayer('{{ pos }}')">Remove</button>
  {% else %}
    <div class="meta">Empty</div>
  {% endif %}
</div>{% endfor %}
</div>
<button class="clear-btn" onclick="clearAll()">Clear All</button>
<form method="GET" class="filters">
  <label>Club <select name="club" onchange="this.form.submit()">
    <option value="">All</option>{% for c in clubs %}
      <option value="{{ c }}" {% if request.args.get('club')==c %}selected{% endif %}>{{ c }}</option>
    {% endfor %}</select></label>
  <label>Position <select name="position" onchange="this.form.submit()">
    <option value="">All</option>{% for p in ['GK','DEF','MID','FWD'] %}
      <option value="{{ p }}" {% if request.args.get('position')==p %}selected{% endif %}>{{ p }}</option>
    {% endfor %}</select></label>
  <div class="filters">
  <input type="text" id="playerSearch" placeholder="Search players..." onkeyup="filterPlayers()">
  </div>
</form>
<table class="table">
<thead><tr><th>Name</th><th>Pick</th><th>Club</th><th>Pos</th><th>Pts</th><th>Next Opp</th></tr></thead>
<tbody>{% for player in players %}
{% set club_taken = player.team_name in selected_clubs %}
<tr>
  <td>{{ player.web_name }}</td>
  <td>
  {% if selected[player.position_name] or club_taken %}
    <button class="btn" disabled>Pick</button>
  {% else %}
    <button class="btn" type="button" onclick="pickPlayer('{{ player.position_name }}', {{ player.id }})">Pick</button>
  {% endif %}
  </td>
  <td>
  {% if player.kit_url %}
    <img src="{{ player.kit_url }}" alt="{{ player.team_name }}" class="club-badge">
  {% endif %}
  </td>
  <td>
    <span class="pos-badge pos-{{ player.position_name }}">
      {{ player.position_name }}
    </span>
  </td>
  <td>{{ player.total_points }}</td>
  <td>{{ player.next_opp }}</td>
</tr>
{% endfor %}</tbody></table>
<div class="pagination">{% set qclub = request.args.get('club') or '' %}{% set qpos = request.args.get('position') or '' %}
{% if current_page>1 %}<a href="?page={{ current_page-1 }}&club={{ qclub }}&position={{ qpos }}">Previous</a>{% endif %}
 Page {{ current_page }} of {{ total_pages }}
{% if current_page<total_pages %}<a href="?page={{ current_page+1 }}&club={{ qclub }}&position={{ qpos }}">Next</a>{% endif %}</div>
<script>
async function pickPlayer(position, playerId){
  const res=await fetch("{{ url_for('pick_player') }}",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({position,player_id:playerId})});
  if(res.ok) location.reload();
}
async function removePlayer(position){
  const res=await fetch("{{ url_for('remove_player') }}",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({position})});
  if(res.ok) location.reload();
}
async function clearAll(){
  const res=await fetch("{{ url_for('clear_team') }}",{method:"POST"});
  if(res.ok) location.reload();
}
function filterPlayers() {
  let input = document.getElementById("playerSearch").value.toLowerCase();
  let rows = document.querySelectorAll(".picks-table tbody tr");

  rows.forEach(row => {
    let nameCell = row.querySelector(".player-name");
    if (nameCell && nameCell.textContent.toLowerCase().includes(input)) {
      row.style.display = "";
    } else {
      row.style.display = "none";
    }
  });
}
</script>
{% endblock %}
