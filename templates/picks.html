{% extends "base.html" %}
{% block content %}
<h2>Pick Team </h2> 
<p class="subtitle">
  League: {{ league_name }}
  </p>
<p class="deadline">
  GW {{ next_gw }} deadline: {{ next_deadline }}
</p>

<div class="grid">
{% for pos in ["GK","DEF","MID","FWD"] %}{% set p = selected[pos] %}
<div class="card player-card">
  <div class="player-pos">{{ pos }}</div>
  {% if p %}
    {% if p.kit_url %}<img class="kit-img" src="{{ p.kit_url }}" alt="{{ p.team_name }} badge">{% endif %}
    <div style="font-weight:700">{{ p.first_name }} {{ p.second_name }}</div>
    <div class="meta">{{ p.team_name }}</div>
    <button class="btn btn-danger" style="margin-top:8px" onclick="removePlayer('{{ pos }}')">Remove</button>
  {% else %}
    <div class="meta">Empty</div>
  {% endif %}
</div>{% endfor %}
</div>

<button class="clear-btn" onclick="clearAll()">Clear All</button>

<div class="sync-box">
  <label>
    <input type="checkbox" id="applyAllLeagues" onchange="toggleSync(this.checked)">
    <span class="sync-label">ðŸ”„ Sync picks across ALL my leagues</span>
  </label>
</div>

<form method="GET" class="filters">
  <!-- Row 1 -->
  <div class="filter-row">
    <label>Club
      <select name="club" onchange="this.form.submit()">
        <option value="">All</option>
        {% for c in clubs %}
          <option value="{{ c }}" {% if request.args.get('club')==c %}selected{% endif %}>
            {{ c }}
          </option>
        {% endfor %}
      </select>
    </label>

    <label>Position
      <select name="position" onchange="this.form.submit()">
        <option value="">All</option>
        {% for p in ['GK','DEF','MID','FWD'] %}
          <option value="{{ p }}" {% if request.args.get('position')==p %}selected{% endif %}>
            {{ p }}
          </option>
        {% endfor %}
      </select>
    </label>
  </div>

  <!-- Row 2 -->
  <div class="filter-row">
    <label for="playerSearch">Search</label>
    <input type="text" id="playerSearch" placeholder="Search players..." onkeyup="filterPlayers()">

    <label>
      <input type="checkbox" id="toggleExtra" onchange="toggleExtraColumns()">
      Extra stats
    </label>
  </div>
</form>

<table class="table picks-table">
  <thead>
    <tr>
      <th>Name</th>
      <th>Pick</th>
      <th>Club</th>
      <th>Pos</th>
      <th>Pts</th>
      <th>Next Opp</th>
      <th class="extra-col">GW Pts</th>
      <th class="extra-col">Mins</th>
      <th class="extra-col">Goals</th>
      <th class="extra-col">Assists</th>
      <th class="extra-col">Cleans</th>
      <th class="extra-col">Bonus</th>
      <th class="extra-col">DCs</th>
    </tr>
  </thead>
  <tbody>
    {% for player in players %}
    {% set club_taken = player.team_name in selected_clubs %}
    <tr>
      <td class="player-webname">{{ player.web_name }}</td>
      <td>
        {% if selected[player.position_name] or club_taken %}
          <button class="btn" disabled>Pick</button>
        {% else %}
          <button class="btn" type="button" onclick="pickPlayer('{{ player.position_name }}', {{ player.id }})">Pick</button>
        {% endif %}
      </td>
      <td>
        {% if player.kit_url %}
          <img src="{{ player.kit_url }}" alt="{{ player.team_name }}" class="club-badge">
        {% endif %}
      </td>
      <td>
        <span class="pos-badge pos-{{ player.position_name }}">
          {{ player.position_name }}
        </span>
      </td>
      <td>{{ player.total_points }}</td>
      <td>{{ player.next_opp }}</td>
      <td class="extra-col">{{ player.last_gw_points }}</td>
      <td class="extra-col">{{ player.minutes }}</td>
      <td class="extra-col">{{ player.goals_scored }}</td>
      <td class="extra-col">{{ player.assists }}</td>
      <td class="extra-col">{{ player.clean_sheets }}</td>
      <td class="extra-col">{{ player.bonus }}</td>
      <td class="extra-col">{{ player.def_contrib }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<div class="pagination">
  {% set qclub = request.args.get('club') or '' %}
  {% set qpos = request.args.get('position') or '' %}
  {% if current_page>1 %}
    <a href="?page={{ current_page-1 }}&club={{ qclub }}&position={{ qpos }}">Previous</a>
  {% endif %}
  Page {{ current_page }} of {{ total_pages }}
  {% if current_page<total_pages %}
    <a href="?page={{ current_page+1 }}&club={{ qclub }}&position={{ qpos }}">Next</a>
  {% endif %}
</div>

<script>
async function pickPlayer(position, playerId){
  const res = await fetch(`/fbj/league/{{ league_id }}/pick_player`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({position, player_id: playerId})
  });
  if(res.ok) location.reload();
}

async function removePlayer(position){
  const res = await fetch(`/fbj/league/{{ league_id }}/remove_player`, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({position})
  });
  if(res.ok) location.reload();
}

async function clearAll(){
  const res = await fetch(`/fbj/league/{{ league_id }}/clear_team`, {method:"POST"});
  if(res.ok) location.reload();
}

function filterPlayers() {
  let input = document.getElementById("playerSearch").value.toLowerCase();
  let rows = document.querySelectorAll(".table tbody tr");

  rows.forEach(row => {
    let nameCell = row.querySelector(".player-webname");
    if (nameCell && nameCell.textContent.toLowerCase().includes(input)) {
      row.style.display = "";
    } else {
      row.style.display = "none";
    }
  });
}

function toggleExtraColumns() {
  let table = document.querySelector(".table");
  if (document.getElementById("toggleExtra").checked) {
    table.classList.add("show-extra");
  } else {
    table.classList.remove("show-extra");
  }
}

async function toggleSync(checked) {
  if (checked) {
    const res = await fetch("{{ url_for('sync_team_to_all', league_id=league_id) }}", {
      method: "POST"
    });
    if (res.ok) {
      location.reload(); // show the flash message
    } else {
      alert("Could not sync team to all leagues.");
      document.getElementById("applyAllLeagues").checked = false;
    }
  }
}

</script>
{% endblock %}