name: FPL Fixtures Update

on:
  schedule:
    - cron: "0 6 */2 * *"   # every 2 days at 06:00 UTC
  workflow_dispatch:

jobs:
  update-fixtures:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-python@v4
        with:
          python-version: "3.x"
      - run: pip install requests
      - name: Update fixtures in fpl_stats.json
        env:
          GIST_ID: ${{ secrets.GIST_ID }}
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
        run: |
          python - <<'EOF'
          import os, requests, json, sys
          GIST_ID, GIST_TOKEN = os.environ["GIST_ID"], os.environ["GIST_TOKEN"]
          headers = {"User-Agent": "Mozilla/5.0"}

          def safe_get(url):
              r = requests.get(url, headers=headers, timeout=30)
              if r.status_code != 200:
                  print(f"⚠️ Failed to fetch {url} ({r.status_code})")
                  sys.exit(0)
              try:
                  return r.json()
              except Exception:
                  print(f"⚠️ Invalid JSON from {url}")
                  sys.exit(0)

          # Get new fixtures
          fixtures = safe_get("https://fantasy.premierleague.com/api/fixtures/")

          # Load existing dataset
          gist_url = f"https://api.github.com/gists/{GIST_ID}"
          gh_headers = {"Authorization": f"Bearer {GIST_TOKEN}"}
          r = requests.get(gist_url, headers=gh_headers)
          r.raise_for_status()
          stats = json.loads(r.json()["files"]["fpl_stats.json"]["content"])

          # Only update fixtures
          stats["fixtures"] = fixtures

          # Save back
          payload = {"files": {"fpl_stats.json": {"content": json.dumps(stats, indent=2)}}}
          resp = requests.patch(gist_url, headers=gh_headers, json=payload)
          resp.raise_for_status()
          print("✅ Fixtures updated in fpl_stats.json")
          EOF
